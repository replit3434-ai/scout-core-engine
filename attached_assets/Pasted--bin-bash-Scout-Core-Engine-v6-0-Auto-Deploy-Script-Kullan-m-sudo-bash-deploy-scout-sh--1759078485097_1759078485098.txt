#!/bin/bash
# Scout Core Engine v6.0 - Auto Deploy Script
# KullanÄ±m: sudo bash deploy_scout.sh
# Gereksinimler: Ubuntu 22.04 LTS, root yetkisi

set -e

# Renkli output iÃ§in
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# DeÄŸiÅŸkenler
APP_DIR="/opt/scout_core"
SERVICE_FILE="/etc/systemd/system/scout_core.service"
MODEL_BACKUP_CRON="/etc/cron.d/scout_model_backup"
LOG_DIR="/var/log/scout_core"
SCOUT_USER="scout"

echo -e "${BLUE}ğŸš€ Scout Core Engine v6.0 - Auto Deploy Script${NC}"
echo -e "${BLUE}=================================================${NC}"

# Root kontrolÃ¼
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}âŒ Bu script root yetkisi ile Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±!${NC}"
   echo "KullanÄ±m: sudo bash deploy_scout.sh"
   exit 1
fi

# API Key kontrolÃ¼
if [[ -z "$SPORTMONKS_API_KEY" || -z "$FOOTYSTATS_API_KEY" ]]; then
    echo -e "${YELLOW}âš ï¸  API anahtarlarÄ± ortam deÄŸiÅŸkeni olarak tanÄ±mlanmamÄ±ÅŸ!${NC}"
    echo "LÃ¼tfen ÅŸu komutlarÄ± Ã§alÄ±ÅŸtÄ±rÄ±n:"
    echo "export SPORTMONKS_API_KEY='your_key_here'"
    echo "export FOOTYSTATS_API_KEY='your_key_here'"
    echo "Sonra scripti tekrar Ã§alÄ±ÅŸtÄ±rÄ±n."
    exit 1
fi

echo -e "${GREEN}âœ… API anahtarlarÄ± bulundu${NC}"

# 1ï¸âƒ£ Sistem gÃ¼ncellemesi ve paket kurulumu
echo -e "${BLUE}ğŸ“¦ Sistem paketleri gÃ¼ncelleniyor...${NC}"
apt update && apt upgrade -y
apt install -y python3 python3-pip python3-venv git htop ufw curl

# 2ï¸âƒ£ Scout kullanÄ±cÄ±sÄ± oluÅŸtur
echo -e "${BLUE}ğŸ‘¤ Scout kullanÄ±cÄ±sÄ± oluÅŸturuluyor...${NC}"
if ! id "$SCOUT_USER" &>/dev/null; then
    useradd -r -s /bin/false -d $APP_DIR $SCOUT_USER
    echo -e "${GREEN}âœ… Scout kullanÄ±cÄ±sÄ± oluÅŸturuldu${NC}"
else
    echo -e "${YELLOW}âš ï¸  Scout kullanÄ±cÄ±sÄ± zaten mevcut${NC}"
fi

# 3ï¸âƒ£ Uygulama dizini oluÅŸtur
echo -e "${BLUE}ğŸ“ Uygulama dizini hazÄ±rlanÄ±yor...${NC}"
mkdir -p $APP_DIR
mkdir -p $LOG_DIR
mkdir -p $APP_DIR/models
mkdir -p $APP_DIR/logs
mkdir -p $APP_DIR/data

# EÄŸer mevcut kod yoksa, Ã¶rnek yapÄ± oluÅŸtur
if [[ ! -f "$APP_DIR/core_engine.py" ]]; then
    echo -e "${YELLOW}âš ï¸  core_engine.py bulunamadÄ±. LÃ¼tfen Scout Core kodlarÄ±nÄ± $APP_DIR dizinine kopyalayÄ±n.${NC}"
    echo "Ã–rnek: git clone https://github.com/your-repo/scout_core.git $APP_DIR"
    echo "Veya dosyalarÄ± manuel olarak kopyalayÄ±n."
    
    # Temel requirements.txt oluÅŸtur
    cat <<EOF > $APP_DIR/requirements.txt
aiohttp>=3.8.0
asyncio
pandas>=1.5.0
numpy>=1.21.0
scikit-learn>=1.1.0
torch>=1.12.0
requests>=2.28.0
python-dotenv>=0.19.0
schedule>=1.1.0
EOF
    echo -e "${GREEN}âœ… Temel requirements.txt oluÅŸturuldu${NC}"
fi

# 4ï¸âƒ£ Python sanal ortamÄ± ve baÄŸÄ±mlÄ±lÄ±klar
echo -e "${BLUE}ğŸ Python sanal ortamÄ± kuruluyor...${NC}"
cd $APP_DIR
python3 -m venv venv
source venv/bin/activate

if [[ -f "requirements.txt" ]]; then
    pip install --upgrade pip
    pip install -r requirements.txt
    echo -e "${GREEN}âœ… Python baÄŸÄ±mlÄ±lÄ±klarÄ± kuruldu${NC}"
else
    echo -e "${RED}âŒ requirements.txt bulunamadÄ±!${NC}"
    exit 1
fi

# 5ï¸âƒ£ Model backup scripti oluÅŸtur
echo -e "${BLUE}ğŸ’¾ Model backup scripti oluÅŸturuluyor...${NC}"
mkdir -p $APP_DIR/utils
cat <<EOF > $APP_DIR/utils/model_backup.py
#!/usr/bin/env python3
"""
Scout Core Engine - Model Backup Script
GÃ¼nlÃ¼k model yedekleme ve performans raporlama
"""
import os
import shutil
import datetime
import logging
from pathlib import Path

# Logging setup
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def backup_models():
    """Model dosyalarÄ±nÄ± yedekle"""
    try:
        models_dir = Path("/opt/scout_core/models")
        backup_dir = Path("/opt/scout_core/backups")
        backup_dir.mkdir(exist_ok=True)
        
        timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
        
        for model_file in models_dir.glob("*.pkl"):
            backup_name = f"{model_file.stem}_{timestamp}.pkl"
            backup_path = backup_dir / backup_name
            shutil.copy2(model_file, backup_path)
            logger.info(f"Model yedeklendi: {backup_name}")
        
        # Eski yedekleri temizle (30 gÃ¼nden eski)
        cutoff_date = datetime.datetime.now() - datetime.timedelta(days=30)
        for backup_file in backup_dir.glob("*.pkl"):
            if backup_file.stat().st_mtime < cutoff_date.timestamp():
                backup_file.unlink()
                logger.info(f"Eski yedek silindi: {backup_file.name}")
                
        logger.info("Model backup iÅŸlemi tamamlandÄ±")
        
    except Exception as e:
        logger.error(f"Model backup hatasÄ±: {e}")

if __name__ == "__main__":
    backup_models()
EOF

chmod +x $APP_DIR/utils/model_backup.py

# 6ï¸âƒ£ systemd servis dosyasÄ± oluÅŸtur
echo -e "${BLUE}âš™ï¸  Systemd servisi oluÅŸturuluyor...${NC}"
cat <<EOF > $SERVICE_FILE
[Unit]
Description=Scout Core Engine v6.0
Documentation=https://github.com/your-repo/scout_core
After=network.target network-online.target
Wants=network-online.target

[Service]
Type=simple
User=$SCOUT_USER
Group=$SCOUT_USER
WorkingDirectory=$APP_DIR
ExecStart=$APP_DIR/venv/bin/python $APP_DIR/core_engine.py
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=scout_core

# Ortam deÄŸiÅŸkenleri
Environment=SPORTMONKS_API_KEY=$SPORTMONKS_API_KEY
Environment=FOOTYSTATS_API_KEY=$FOOTYSTATS_API_KEY
Environment=PYTHONPATH=$APP_DIR
Environment=LOG_LEVEL=INFO

# GÃ¼venlik
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=$APP_DIR $LOG_DIR

[Install]
WantedBy=multi-user.target
EOF

# 7ï¸âƒ£ Dosya izinlerini ayarla
echo -e "${BLUE}ğŸ” Dosya izinleri ayarlanÄ±yor...${NC}"
chown -R $SCOUT_USER:$SCOUT_USER $APP_DIR
chown -R $SCOUT_USER:$SCOUT_USER $LOG_DIR
chmod +x $APP_DIR/core_engine.py 2>/dev/null || echo "core_engine.py bulunamadÄ±, manuel olarak executable yapÄ±n"

# 8ï¸âƒ£ Servisi etkinleÅŸtir
echo -e "${BLUE}ğŸš€ Servis etkinleÅŸtiriliyor...${NC}"
systemctl daemon-reload
systemctl enable scout_core

# 9ï¸âƒ£ Cron job oluÅŸtur
echo -e "${BLUE}â° Cron job oluÅŸturuluyor...${NC}"
cat <<EOF > $MODEL_BACKUP_CRON
# Scout Core Engine - Model Backup (Her gÃ¼n 03:00)
0 3 * * * $SCOUT_USER $APP_DIR/venv/bin/python $APP_DIR/utils/model_backup.py >> $LOG_DIR/model_backup.log 2>&1

# Scout Core Engine - HaftalÄ±k performans raporu (Pazartesi 04:00)
0 4 * * 1 $SCOUT_USER $APP_DIR/venv/bin/python $APP_DIR/utils/weekly_report.py >> $LOG_DIR/weekly_report.log 2>&1
EOF

# ğŸ”Ÿ Firewall ayarlarÄ±
echo -e "${BLUE}ğŸ”¥ Firewall ayarlanÄ±yor...${NC}"
ufw --force enable
ufw allow ssh
ufw allow 8000/tcp comment "Scout Core API"
echo -e "${GREEN}âœ… Firewall ayarlandÄ±${NC}"

# 1ï¸âƒ£1ï¸âƒ£ Servisi baÅŸlat
echo -e "${BLUE}â–¶ï¸  Servis baÅŸlatÄ±lÄ±yor...${NC}"
if systemctl start scout_core; then
    echo -e "${GREEN}âœ… Scout Core Engine baÅŸarÄ±yla baÅŸlatÄ±ldÄ±!${NC}"
else
    echo -e "${RED}âŒ Servis baÅŸlatÄ±lamadÄ±. LoglarÄ± kontrol edin.${NC}"
    echo "Debug iÃ§in: journalctl -fu scout_core"
fi

# 1ï¸âƒ£2ï¸âƒ£ Kurulum Ã¶zeti
echo -e "${GREEN}"
echo "ğŸ‰ KURULUM TAMAMLANDI!"
echo "===================="
echo -e "${NC}"
echo -e "${BLUE}ğŸ“ Uygulama Dizini:${NC} $APP_DIR"
echo -e "${BLUE}ğŸ“ Log Dizini:${NC} $LOG_DIR"
echo -e "${BLUE}ğŸ“ Servis DosyasÄ±:${NC} $SERVICE_FILE"
echo ""
echo -e "${YELLOW}ğŸ”§ YÃ¶netim KomutlarÄ±:${NC}"
echo "  Servis durumu:     systemctl status scout_core"
echo "  Servisi durdur:    systemctl stop scout_core"
echo "  Servisi baÅŸlat:    systemctl start scout_core"
echo "  Servisi yeniden baÅŸlat: systemctl restart scout_core"
echo "  CanlÄ± loglar:      journalctl -fu scout_core"
echo ""
echo -e "${YELLOW}ğŸ“Š Log DosyalarÄ±:${NC}"
echo "  Ana loglar:        journalctl -u scout_core"
echo "  Model backup:      $LOG_DIR/model_backup.log"
echo "  HaftalÄ±k rapor:    $LOG_DIR/weekly_report.log"
echo ""
echo -e "${YELLOW}ğŸ”„ GÃ¼ncelleme iÃ§in:${NC}"
echo "  cd $APP_DIR && git pull origin main"
echo "  systemctl restart scout_core"
echo ""
echo -e "${GREEN}ğŸš€ Scout Core Engine v6.0 production ortamÄ±nda Ã§alÄ±ÅŸmaya hazÄ±r!${NC}"

# Servis durumunu gÃ¶ster
sleep 2
systemctl status scout_core --no-pager